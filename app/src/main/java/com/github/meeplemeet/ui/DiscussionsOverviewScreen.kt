// Class done almost all manually except some parts inspired from DiscussionScreen.kt
// and others were generated or modified using chatGPT-5 Thinking Extended
// Comments were generated by integrated copilot in Android Studio
package com.github.meeplemeet.ui

import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.IntrinsicSize
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxHeight
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.offset
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.CenterAlignedTopAppBar
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.FloatingActionButton
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.produceState
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.platform.testTag
import androidx.compose.ui.unit.dp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.github.meeplemeet.model.structures.Account
import com.github.meeplemeet.model.structures.Discussion
import com.github.meeplemeet.model.viewmodels.FirestoreViewModel
import com.github.meeplemeet.ui.navigation.BottomNavigationMenu
import com.github.meeplemeet.ui.navigation.MeepleMeetScreen
import com.github.meeplemeet.ui.navigation.NavigationActions
import com.github.meeplemeet.ui.navigation.NavigationTestTags
import com.github.meeplemeet.ui.theme.AppColors
import com.github.meeplemeet.ui.theme.Elevation

/* ================================================================
 * Variables
 * ================================================================ */
const val MY_MSG_USERNAME = "You"
const val DEFAULT_DISCUSSION_NAME = "Discussion"
const val NO_MESSAGES_DEFAULT_TEXT = "(No messages yet)"
const val NO_DISCUSSIONS_DEFAULT_TEXT = "No discussions yet"

object DiscussionOverviewTestTags {
  const val ADD_DISCUSSION_BUTTON = "Add Discussion"
}

/* ================================================================
 * Screen: Discussions Overview
 * ================================================================ */

/**
 * Screen that shows an overview of all discussions the user is part of
 *
 * @param viewModel [FirestoreViewModel] instance to interact with Firestore
 * @param account The currently logged-in user ([Account])
 * @param navigation [NavigationActions] instance to navigate to other screens
 * @param onSelectDiscussion Callback function when a discussion is clicked
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DiscussionsOverviewScreen(
    account: Account,
    navigation: NavigationActions,
    viewModel: FirestoreViewModel = viewModel(),
    onClickAddDiscussion: () -> Unit = {},
    onSelectDiscussion: (Discussion) -> Unit = {},
) {
  val discussionPreviewsSorted =
      remember(account.previews) {
        account.previews.values.sortedByDescending { it.lastMessageAt.toDate() }
      }

  Scaffold(
      floatingActionButton = {
        FloatingActionButton(
            onClick = onClickAddDiscussion,
            contentColor = AppColors.textIcons,
            containerColor = AppColors.neutral,
            modifier = Modifier.testTag(DiscussionOverviewTestTags.ADD_DISCUSSION_BUTTON)) {
              Icon(Icons.Default.Add, contentDescription = "Create")
            }
      },
      topBar = {
        CenterAlignedTopAppBar(
            title = {
              Text(
                  text = MeepleMeetScreen.DiscussionsOverview.title,
                  style = MaterialTheme.typography.bodyMedium,
                  color = MaterialTheme.colorScheme.onPrimary,
                  modifier = Modifier.testTag(NavigationTestTags.SCREEN_TITLE))
            })
      },
      bottomBar = {
        BottomNavigationMenu(
            currentScreen = MeepleMeetScreen.DiscussionsOverview,
            onTabSelected = { screen -> navigation.navigateTo(screen) })
      }) { innerPadding ->
        if (discussionPreviewsSorted.isEmpty()) {
          Box(modifier = Modifier.fillMaxSize().padding(innerPadding)) {
            EmptyDiscussionsListText()
          }
        } else {
          LazyColumn(
              modifier =
                  Modifier.fillMaxSize()
                      .background(MaterialTheme.colorScheme.background)
                      .padding(innerPadding),
              verticalArrangement = Arrangement.spacedBy(10.dp),
              contentPadding = PaddingValues(horizontal = 16.dp, vertical = 12.dp)) {
                items(discussionPreviewsSorted, key = { it.uid }) { preview ->
                  val discussion by viewModel.discussionFlow(preview.uid).collectAsState()
                  val discussionName = discussion?.name ?: DEFAULT_DISCUSSION_NAME

                  val senderId = preview.lastMessageSender
                  val isMe = (senderId == account.uid)
                  val senderName by
                      produceState(
                          key1 = senderId, initialValue = if (isMe) MY_MSG_USERNAME else null) {
                            if (senderId.isNotBlank() && !isMe) {
                              viewModel.getOtherAccount(senderId) { acc -> value = acc.name }
                            }
                          }

                  val msgText = buildString {
                    if (preview.lastMessage.isBlank()) {
                      append(NO_MESSAGES_DEFAULT_TEXT)
                    } else {
                      if (isMe) append("$MY_MSG_USERNAME: ")
                      else if (!senderName.isNullOrBlank()) append("$senderName: ")
                      append(preview.lastMessage)
                    }
                  }

                  DiscussionCard(
                      discussionName = discussionName,
                      lastMsg = msgText,
                      unreadMsgCount = preview.unreadCount,
                      modifier =
                          Modifier.fillMaxWidth()
                              .testTag(DiscussionTestTags.discussionInfo(discussionName)),
                      onClick = { discussion?.let { onSelectDiscussion(it) } })
                }
              }
        }
      }
}

/* ================================================================
 * Composables
 * ================================================================ */

/** Composable that displays a message when there are no discussions */
@Composable
private fun EmptyDiscussionsListText() {
  Box(
      modifier =
          Modifier.fillMaxSize().padding(24.dp).background(MaterialTheme.colorScheme.background),
      contentAlignment = Alignment.Center) {
        Text(
            text = NO_DISCUSSIONS_DEFAULT_TEXT,
            style = MaterialTheme.typography.bodyMedium,
            color = MaterialTheme.colorScheme.onPrimary,
        )
      }
}

/**
 * Composable that displays a discussion card
 *
 * @param discussionName Discussion name
 * @param lastMsg Last message text
 * @param unreadMsgCount Number of unseen messages in this discussion
 * @param modifier Optional [Modifier] for this composable
 * @param onClick Function to operate when clicked
 */
@Composable
private fun DiscussionCard(
    discussionName: String,
    lastMsg: String,
    unreadMsgCount: Int,
    modifier: Modifier = Modifier,
    onClick: () -> Unit = {}
) {
  val shape = MaterialTheme.shapes.large
  val rightPaneWidth = 90.dp

  Card(
      onClick = onClick,
      modifier = modifier,
      colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.outline),
      shape = shape,
      elevation = CardDefaults.cardElevation(defaultElevation = Elevation.raised)) {
        Box(modifier = Modifier.fillMaxWidth().height(IntrinsicSize.Min).clip(shape)) {

          // LEFT + MIDDLE:
          Row(
              modifier =
                  Modifier.fillMaxWidth()
                      .padding(horizontal = 16.dp, vertical = 12.dp)
                      .padding(end = rightPaneWidth),
              verticalAlignment = Alignment.CenterVertically,
              horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                // LEFT: last message user's image (placeholder)
                Box(
                    Modifier.size(40.dp)
                        .background(MaterialTheme.colorScheme.inversePrimary, CircleShape))
                // MIDDLE: discussion title + last message
                DiscussionCardTextSection(discussionName, lastMsg, Modifier.weight(1f))
              }

          // RIGHT: discussion image (placeholder) + unread messages
          Box(
              modifier =
                  Modifier.align(Alignment.CenterEnd)
                      .fillMaxHeight()
                      .width(rightPaneWidth)
                      .background(MaterialTheme.colorScheme.tertiary))

          Box(
              modifier =
                  Modifier.align(Alignment.BottomEnd)
                      .offset(x = (-1).dp, y = (-1).dp)
                      .size(26.dp)
                      .background(MaterialTheme.colorScheme.inversePrimary, CircleShape)
                      .border(
                          width = 1.5.dp,
                          color = MaterialTheme.colorScheme.outline,
                          shape = CircleShape),
              contentAlignment = Alignment.Center) {
                Text(
                    text = unreadMsgCount.toString(),
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onPrimary)
              }
        }
      }
}

/**
 * Text section of a discussion card
 *
 * Displays the discussion title text and the last message text
 *
 * @param discussionName Discussion name
 * @param lastMsg Last message text
 * @param modifier Optional [Modifier] for this composable
 */
@Composable
private fun DiscussionCardTextSection(
    discussionName: String,
    lastMsg: String,
    modifier: Modifier = Modifier
) {
  Column(modifier = modifier, verticalArrangement = Arrangement.Center) {
    Text(
        text = discussionName,
        style = MaterialTheme.typography.bodyMedium,
        color = MaterialTheme.colorScheme.onSurface,
        maxLines = 1)
    Spacer(modifier = Modifier.height(4.dp))
    Text(
        text = lastMsg,
        style = MaterialTheme.typography.bodySmall,
        color = MaterialTheme.colorScheme.onSurface,
        maxLines = 1)
  }
}
