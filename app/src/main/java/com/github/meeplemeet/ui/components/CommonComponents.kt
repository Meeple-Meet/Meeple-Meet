// Some comments were generated by ChatGPT
package com.github.meeplemeet.ui.components

import android.Manifest
import android.content.pm.PackageManager
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.combinedClickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.navigationBarsPadding
import androidx.compose.foundation.layout.offset
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.statusBarsPadding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.layout.widthIn
import androidx.compose.foundation.pager.HorizontalPager
import androidx.compose.foundation.pager.rememberPagerState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.AddAPhoto
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Block
import androidx.compose.material.icons.filled.Image
import androidx.compose.material.icons.filled.Person
import androidx.compose.material.icons.filled.PersonAdd
import androidx.compose.material.icons.filled.PersonRemove
import androidx.compose.material.icons.filled.PhotoCamera
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardColors
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.ElevatedCard
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Snackbar
import androidx.compose.material3.SnackbarDuration
import androidx.compose.material3.SnackbarHost
import androidx.compose.material3.SnackbarHostState
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.testTag
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.window.Dialog
import androidx.compose.ui.window.DialogProperties
import androidx.core.content.ContextCompat
import coil.compose.AsyncImage
import coil.compose.rememberAsyncImagePainter
import com.github.meeplemeet.R
import com.github.meeplemeet.model.account.Account
import com.github.meeplemeet.model.account.RelationshipStatus
import com.github.meeplemeet.model.account.UserProfilePopupActions
import com.github.meeplemeet.model.images.ImageFileUtils
import com.github.meeplemeet.ui.discussions.UITestTags
import com.github.meeplemeet.ui.theme.AppColors
import com.github.meeplemeet.ui.theme.Dimensions
import kotlinx.coroutines.launch

// Contains test tag constants for common UI components.
object CommonComponentsTestTags {
  const val IMAGE_CAROUSEL = "ImageCarousel"
  const val CAROUSEL_ADD_BUTTON = "CarouselAddButton"
  const val CAROUSEL_IMAGE = "CarouselImage"
  const val CAROUSEL_REMOVE_BUTTON = "CarouselRemoveButton"
  const val DOT = "dot"
  const val GALLERY_DIALOG_ROOT = "GalleryDialogRoot"
  const val PHOTO_DIALOG_BACK_BUTTON = "PhotoDialogBackButton"
  const val PHOTO_DIALOG_CAMERA_BUTTON = "PhotoDialogCameraButton"
  const val PHOTO_DIALOG_GALLERY_BUTTON = "PhotoDialogGalleryButton"
  const val CONFIRMATION_DIALOG = "ConfirmationDialog"
  const val CONFIRMATION_DIALOG_TITLE = "ConfirmationDialogTitle"
  const val CONFIRMATION_DIALOG_MESSAGE = "ConfirmationDialogMessage"
  const val CONFIRMATION_DIALOG_CONFIRM = "ConfirmationDialogConfirm"
  const val CONFIRMATION_DIALOG_CANCEL = "ConfirmationDialogCancel"
  const val USER_PROFILE_POPUP_DESCRIPTION = "UserProfilePopupDescription"
  const val USER_PROFILE_POPUP_HANDLE = "UserProfilePopupHandle"
  const val USER_PROFILE_POPUP_USERNAME = "UserProfilePopupUsername"
  const val USER_PROFILE_POPUP_AVATAR = "UserProfilePopupAvatar"
  const val USER_PROFILE_POPUP_BLOCK_BUTTON = "UserProfilePopupBlockButton"
  const val USER_PROFILE_POPUP_SEND_REQUEST_BUTTON = "UserProfilePopupSendRequestButton"
  const val USER_PROFILE_POPUP_REMOVE_FRIEND_BUTTON = "UserProfilePopupRemoveFriendButton"
}

// The default size for the image carousel.
val CAROUSEL_SIZE = 260.dp
val SNACKBAR_OFFSET = 50.dp

// The label for the "Add Picture" action.
const val ADD_PICTURE = "Add Picture"

/**
 * Displays a horizontally scrollable image carousel with optional add/remove functionality.
 *
 * @param modifier Modifier to be applied to the carousel.
 * @param maxNumberOfImages The maximum number of images that can be shown/added.
 * @param photoCollectionUrl List of image URLs to display.
 * @param editable If true, allows adding/removing images.
 * @param onAdd Callback when a new image is added. Receives the image path and the insertion index.
 * @param onRemove Callback when an image is removed. Receives the image path.
 */
@OptIn(ExperimentalFoundationApi::class)
@Composable
fun ImageCarousel(
    modifier: Modifier = Modifier,
    maxNumberOfImages: Int = 10,
    photoCollectionUrl: List<String>,
    editable: Boolean = true,
    onAdd: suspend (String, Int) -> Unit = { _, _ -> },
    onRemove: (String) -> Unit = {}
) {
  // --- Setup ---
  val canAddMoreImages = editable && photoCollectionUrl.size < maxNumberOfImages
  val coroutineScope = rememberCoroutineScope()
  val context = LocalContext.current

  // --- Pager state ---
  val pagerState =
      rememberPagerState(
          pageCount = {
            if (canAddMoreImages) photoCollectionUrl.size + 1 else photoCollectionUrl.size
          })

  // --- Image source selection state ---
  var showImageSourceMenu by remember { mutableStateOf(false) }

  // --- Camera launcher ---
  val cameraLauncher =
      rememberLauncherForActivityResult(ActivityResultContracts.TakePicturePreview()) { bitmap ->
        if (bitmap != null) {
          coroutineScope.launch {
            val path = ImageFileUtils.saveBitmapToCache(context, bitmap)
            onAdd(path, pagerState.currentPage)
          }
        }
      }
  // --- Image upload handler ---
  val uploadImage: suspend (String) -> Unit = { path ->
    try {
      onAdd(path, pagerState.currentPage)
    } catch (e: Exception) {
      // Handle error silently or show a snackbar
    }
  }

  // --- Camera permission launcher ---
  val cameraPermissionLauncher =
      rememberLauncherForActivityResult(ActivityResultContracts.RequestPermission()) { granted ->
        if (granted) {
          cameraLauncher.launch(null)
        }
      }

  // --- Gallery launcher ---
  val galleryLauncher =
      rememberLauncherForActivityResult(ActivityResultContracts.GetContent()) { uri ->
        if (uri != null) {
          coroutineScope.launch {
            val path = ImageFileUtils.cacheUriToFile(context, uri)
            uploadImage(path)
          }
        }
      }

  Column(
      modifier = modifier.testTag(CommonComponentsTestTags.IMAGE_CAROUSEL),
      horizontalAlignment = Alignment.CenterHorizontally) {
        ElevatedCard(
            modifier = Modifier.fillMaxWidth().height(CAROUSEL_SIZE),
            colors =
                CardColors(
                    containerColor = AppColors.secondary,
                    contentColor = AppColors.textIcons,
                    disabledContentColor = AppColors.textIconsFade,
                    disabledContainerColor = AppColors.negative),
            shape = MaterialTheme.shapes.medium) {
              HorizontalPager(state = pagerState, modifier = Modifier.fillMaxSize()) { page ->
                if (editable &&
                    (photoCollectionUrl.isEmpty() || page == photoCollectionUrl.size) &&
                    canAddMoreImages) {
                  Box(
                      modifier =
                          Modifier.fillMaxSize()
                              .padding(Dimensions.Padding.giant)
                              .testTag(CommonComponentsTestTags.CAROUSEL_ADD_BUTTON)
                              .clickable { if (canAddMoreImages) showImageSourceMenu = true },
                      contentAlignment = Alignment.Center) {
                        Icon(
                            imageVector = Icons.Default.AddAPhoto,
                            contentDescription = ADD_PICTURE,
                            modifier =
                                Modifier.size(
                                    Dimensions.IconSize.massive.times(
                                        Dimensions.Multipliers.quadruple)),
                            tint =
                                AppColors.divider.copy(
                                    alpha = Dimensions.Alpha.dialogIconTranslucent))
                      }
                } else {
                  Box(modifier = Modifier.fillMaxSize()) {
                    AsyncImage(
                        model = photoCollectionUrl[page],
                        contentDescription = "Discussion Profile Picture",
                        contentScale = ContentScale.Fit,
                        modifier =
                            Modifier.fillMaxSize()
                                .clickable { showImageSourceMenu = true }
                                .testTag(CommonComponentsTestTags.CAROUSEL_IMAGE),
                        placeholder =
                            androidx.compose.ui.res.painterResource(R.drawable.ic_storefront),
                        error = androidx.compose.ui.res.painterResource(R.drawable.ic_storefront))
                    if (page < photoCollectionUrl.size && editable) {
                      Box(
                          modifier =
                              Modifier.align(Alignment.TopEnd)
                                  .padding(Dimensions.Padding.medium)
                                  .size(Dimensions.IconSize.extraLarge)
                                  .clip(CircleShape)
                                  .background(AppColors.negative)
                                  .clickable { onRemove(photoCollectionUrl[page]) }
                                  .testTag(CommonComponentsTestTags.CAROUSEL_REMOVE_BUTTON),
                          contentAlignment = Alignment.Center) {
                            Text(
                                text = "-",
                                color = AppColors.textIcons,
                                style = MaterialTheme.typography.titleMedium)
                          }
                    }
                  }
                }
              }
            }

        Spacer(Modifier.height(Dimensions.Spacing.large))

        // --- Dots Indicator
        Row(
            horizontalArrangement = Arrangement.Center,
            verticalAlignment = Alignment.CenterVertically) {
              if ((editable && (photoCollectionUrl.size + 1) > 1) ||
                  (!editable && photoCollectionUrl.size > 1)) {
                repeat(if (editable) photoCollectionUrl.size + 1 else photoCollectionUrl.size) {
                    index ->
                  val selected = pagerState.currentPage == index

                  Box(
                      modifier =
                          Modifier.padding(Dimensions.Padding.small)
                              .size(
                                  if (selected) Dimensions.Padding.extraMedium
                                  else Dimensions.Padding.medium)
                              .clip(CircleShape)
                              .background(
                                  if (selected) MaterialTheme.colorScheme.primary
                                  else MaterialTheme.colorScheme.surfaceVariant)
                              .testTag(CommonComponentsTestTags.DOT))
                }
              }
            }
        if (showImageSourceMenu) {
          GalleryDialog(
              pageNumber = pagerState.currentPage,
              galleryPictureUrl = photoCollectionUrl,
              onDismiss = { showImageSourceMenu = false },
              onTakePhoto = {
                if (editable) {
                  showImageSourceMenu = false
                  val permission = Manifest.permission.CAMERA
                  if (ContextCompat.checkSelfPermission(context, permission) ==
                      PackageManager.PERMISSION_GRANTED) {
                    cameraLauncher.launch(null)
                  } else {
                    cameraPermissionLauncher.launch(permission)
                  }
                }
              },
              onChooseFromGallery = {
                if (editable) {
                  showImageSourceMenu = false
                  galleryLauncher.launch("image/*")
                }
              },
              editable = editable)
        }
      }
}

/**
 * Top bar for the photo dialog, containing a dismiss button and title.
 *
 * @param modifier Modifier to be applied to the top bar.
 * @param text Title text to display.
 * @param onDismiss Callback when the dismiss button is pressed.
 */
@Composable
fun PhotoDialogTopBar(
    modifier: Modifier = Modifier,
    text: String = ADD_PICTURE,
    onDismiss: () -> Unit
) {
  Box(
      modifier =
          modifier
              .fillMaxWidth()
              .statusBarsPadding()
              .background(
                  Brush.verticalGradient(
                      listOf(
                          AppColors.primary.copy(alpha = Dimensions.Alpha.dialogOverlayDark),
                          AppColors.primary.copy(
                              alpha = Dimensions.Alpha.dialogOverlayTransparent))))) {
        Row(
            modifier =
                Modifier.fillMaxWidth()
                    .padding(
                        horizontal = Dimensions.Padding.extraLarge,
                        vertical = Dimensions.Spacing.medium),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.SpaceBetween) {
              IconButton(
                  onClick = onDismiss,
                  modifier = Modifier.testTag(CommonComponentsTestTags.PHOTO_DIALOG_BACK_BUTTON)) {
                    Icon(
                        imageVector = Icons.AutoMirrored.Filled.ArrowBack,
                        contentDescription = "Back",
                        tint = AppColors.textIcons)
                  }

              Text(
                  text = text,
                  color = AppColors.textIcons,
                  style = MaterialTheme.typography.titleMedium,
                  modifier =
                      Modifier.weight(Dimensions.Weight.full)
                          .padding(horizontal = Dimensions.Spacing.large)
                          .testTag(UITestTags.PROFILE_PICTURE_DIALOG_TITLE),
                  textAlign = TextAlign.Center)

              Spacer(modifier = Modifier.width(Dimensions.IconSize.extraLarge))
            }
      }
}

/**
 * Bottom bar for the photo dialog, with buttons to take a photo or choose from gallery.
 *
 * @param modifier Modifier to be applied to the bottom bar.
 * @param onTakePhoto Callback when the "Camera" button is pressed.
 * @param onChooseFromGallery Callback when the "Gallery" button is pressed.
 */
@Composable
fun PhotoDialogBottomBar(
    modifier: Modifier = Modifier,
    onTakePhoto: () -> Unit,
    onChooseFromGallery: () -> Unit
) {
  Box(modifier = modifier.fillMaxWidth().navigationBarsPadding().background(AppColors.primary)) {
    Row(
        modifier =
            Modifier.fillMaxWidth()
                .padding(
                    horizontal = Dimensions.Padding.extraLarge,
                    vertical = Dimensions.Spacing.extraLarge),
        horizontalArrangement =
            Arrangement.spacedBy(Dimensions.Spacing.large, Alignment.CenterHorizontally),
        verticalAlignment = Alignment.CenterVertically) {
          Button(
              onClick = onTakePhoto,
              colors =
                  ButtonDefaults.buttonColors(
                      containerColor = AppColors.textIcons.copy(alpha = 0.2f),
                      contentColor = AppColors.textIconsFade),
              modifier = Modifier.weight(1f).testTag(UITestTags.PROFILE_PICTURE_CAMERA_OPTION)) {
                Icon(
                    imageVector = Icons.Default.PhotoCamera,
                    contentDescription = "Take Photo",
                    modifier = Modifier.size(Dimensions.IconSize.large))
                Spacer(modifier = Modifier.width(Dimensions.Spacing.medium))
                Text(
                    "Camera",
                    style = MaterialTheme.typography.bodyLarge,
                    color = AppColors.textIcons)
              }

          Button(
              onClick = onChooseFromGallery,
              colors =
                  ButtonDefaults.buttonColors(
                      containerColor = AppColors.textIcons.copy(alpha = 0.2f),
                      contentColor = AppColors.textIconsFade),
              modifier = Modifier.weight(1f).testTag(UITestTags.PROFILE_PICTURE_GALLERY_OPTION)) {
                Icon(
                    imageVector = Icons.Default.Image,
                    contentDescription = "Choose from Gallery",
                    modifier = Modifier.size(Dimensions.IconSize.large))
                Spacer(modifier = Modifier.width(Dimensions.Spacing.medium))
                Text(
                    "Gallery",
                    style = MaterialTheme.typography.bodyLarge,
                    color = AppColors.textIcons)
              }
        }
  }
}

/**
 * Displays a full-screen dialog showing an image (or add photo icon) with top and bottom bars.
 *
 * @param pageNumber The index of the currently selected image.
 * @param galleryPictureUrl List of image URLs to display.
 * @param onDismiss Callback when the dialog is dismissed.
 * @param onTakePhoto Callback for taking a new photo.
 * @param onChooseFromGallery Callback for picking a photo from the gallery.
 * @param editable If true, shows the bottom bar for adding images.
 */
@OptIn(ExperimentalFoundationApi::class)
@Composable
fun GalleryDialog(
    pageNumber: Int,
    galleryPictureUrl: List<String>?,
    onDismiss: () -> Unit,
    onTakePhoto: () -> Unit,
    onChooseFromGallery: () -> Unit,
    editable: Boolean = true
) {
  val isRealImage = pageNumber in (galleryPictureUrl?.indices ?: IntRange.EMPTY)
  Dialog(
      onDismissRequest = onDismiss,
      properties =
          DialogProperties(usePlatformDefaultWidth = false, decorFitsSystemWindows = false)) {
        Box(
            modifier =
                Modifier.fillMaxSize()
                    .background(AppColors.primary)
                    .testTag(CommonComponentsTestTags.GALLERY_DIALOG_ROOT)) {
              // Image or default icon
              if (isRealImage) {
                AsyncImage(
                    model = galleryPictureUrl!![pageNumber],
                    contentDescription = "Discussion Profile Picture",
                    contentScale = ContentScale.Fit,
                    modifier = Modifier.fillMaxSize().combinedClickable(onClick = { onDismiss() }))
              } else {
                Box(
                    modifier = Modifier.fillMaxSize().clickable { onDismiss() },
                    contentAlignment = Alignment.Center) {
                      Icon(
                          imageVector = Icons.Default.AddAPhoto,
                          contentDescription = "Default Add Photo Icon",
                          modifier =
                              Modifier.size(
                                  Dimensions.IconSize.massive.times(
                                      Dimensions.Multipliers.quadruple)),
                          tint =
                              AppColors.textIcons.copy(
                                  alpha = Dimensions.Alpha.dialogIconTranslucent))
                    }
              }

              PhotoDialogTopBar(
                  Modifier.align(Alignment.TopCenter),
                  if (isRealImage) {
                    "Image ${pageNumber + 1} of ${galleryPictureUrl?.size ?: 0}"
                  } else {
                    ADD_PICTURE
                  },
                  onDismiss)

              if (editable) {
                PhotoDialogBottomBar(
                    Modifier.align(Alignment.BottomCenter), onTakePhoto, onChooseFromGallery)
              }
            }
      }
}
/**
 * Reusable helper that centralizes the ImageCarousel add/remove behavior used in both
 * CreateSpaceRenter and EditSpaceRenter screens.
 *
 * Parameters:
 * - photoCollectionUrl: current list of image URLs
 * - spacesCount: number of spaces (used to compute maxNumberOfImages)
 * - setPhotoCollectionUrl: setter to update the caller's state
 */
@Composable
fun EditableImageCarousel(
    photoCollectionUrl: List<String>,
    spacesCount: Int,
    setPhotoCollectionUrl: (List<String>) -> Unit
) {
  ImageCarousel(
      photoCollectionUrl = photoCollectionUrl,
      maxNumberOfImages = spacesCount + 2,
      onAdd = { path, index ->
        val newList =
            if (index < photoCollectionUrl.size && photoCollectionUrl[index].isNotEmpty()) {
              photoCollectionUrl.mapIndexed { i, old -> if (i == index) path else old }
            } else {
              photoCollectionUrl + path
            }
        setPhotoCollectionUrl(newList)
      },
      onRemove = { url -> setPhotoCollectionUrl(photoCollectionUrl.filter { it != url }) },
      editable = true)
}

/**
 * Displays a confirmation dialog with customizable title, message, and action buttons.
 *
 * @param show Whether the dialog should be displayed.
 * @param title The title text of the dialog.
 * @param message The message text of the dialog.
 * @param confirmText The text for the confirm button.
 * @param cancelText The text for the cancel button.
 * @param onConfirm Callback invoked when the confirm button is clicked.
 * @param onDismiss Callback invoked when the dialog is dismissed (via cancel button or outside
 *   click).
 * @param dialogTestTag Optional test tag for the dialog container.
 * @param confirmTestTag Optional test tag for the confirm button.
 * @param cancelTestTag Optional test tag for the cancel button.
 */
@Composable
fun ConfirmationDialog(
    show: Boolean,
    title: String,
    message: String,
    confirmText: String,
    cancelText: String,
    onConfirm: () -> Unit,
    onDismiss: () -> Unit,
    dialogTestTag: String = CommonComponentsTestTags.CONFIRMATION_DIALOG,
    confirmTestTag: String = CommonComponentsTestTags.CONFIRMATION_DIALOG_CONFIRM,
    cancelTestTag: String = CommonComponentsTestTags.CONFIRMATION_DIALOG_CANCEL
) {
  if (show) {
    AlertDialog(
        onDismissRequest = onDismiss,
        containerColor = AppColors.primary,
        title = {
          Text(
              title,
              modifier = Modifier.testTag(CommonComponentsTestTags.CONFIRMATION_DIALOG_TITLE))
        },
        text = {
          Text(
              message,
              modifier = Modifier.testTag(CommonComponentsTestTags.CONFIRMATION_DIALOG_MESSAGE))
        },
        confirmButton = {
          TextButton(onClick = onConfirm, modifier = Modifier.testTag(confirmTestTag)) {
            Text(confirmText)
          }
        },
        dismissButton = {
          TextButton(onClick = onDismiss, modifier = Modifier.testTag(cancelTestTag)) {
            Text(cancelText)
          }
        },
        modifier = Modifier.testTag(dialogTestTag))
  }
}

/**
 * A toast that can be closed by clicking on the close icon.
 *
 * @param message The message to display.
 * @param onDismiss Callback when the toast is dismissed.
 * @param modifier Modifier to be applied to the toast.
 */
@Composable
fun ClosableToast(message: String, onDismiss: () -> Unit, modifier: Modifier = Modifier) {
  androidx.compose.material3.Surface(
      modifier = modifier.widthIn(max = 280.dp),
      color = AppColors.secondary,
      shape = androidx.compose.foundation.shape.RoundedCornerShape(Dimensions.CornerRadius.medium),
      shadowElevation = Dimensions.Elevation.high) {
        Row(
            modifier =
                Modifier.padding(
                    start = Dimensions.Padding.extraLarge,
                    end = Dimensions.Padding.small,
                    top = Dimensions.Padding.small,
                    bottom = Dimensions.Padding.small),
            verticalAlignment = Alignment.CenterVertically) {
              Text(
                  text = message,
                  color = AppColors.textIcons,
                  style = MaterialTheme.typography.bodyMedium,
                  modifier = Modifier.weight(1f))
              Spacer(modifier = Modifier.width(Dimensions.Spacing.medium))
              Icon(
                  imageVector = Icons.Filled.Close,
                  contentDescription = "Close",
                  tint = AppColors.textIcons,
                  modifier = Modifier.size(20.dp).clickable { onDismiss() })
            }
      }
}

/**
 * Displays a popup dialog showing another user's profile information with action buttons.
 *
 * This composable presents a dialog containing the target user's profile details including their
 * name, handle, avatar, and description. It provides interactive buttons to block the user or
 * manage friendship status (send friend request or remove friend).
 *
 * @param visible Whether the popup dialog should be displayed. If false, nothing is rendered.
 * @param curr The current user's account performing the action.
 * @param target The target user whose profile is being displayed.
 * @param isFriend Whether the target user is currently a friend of the current user.
 * @param onDismiss Callback invoked when the dialog should be dismissed.
 * @param actions Implementation of [UserProfilePopupActions] providing block and friend management
 *   functionality.
 */
@Composable
fun UserProfilePopup(
    visible: Boolean,
    curr: Account,
    target: Account,
    isFriend: Boolean,
    online: Boolean,
    onDismiss: () -> Unit,
    actions: UserProfilePopupActions
) {
  if (!visible) return

  var snackbarMessage by remember { mutableStateOf<String?>(null) }
  val snackbarHostState = remember { SnackbarHostState() }

  LaunchedEffect(snackbarMessage) {
    snackbarMessage?.let { message ->
      snackbarHostState.showSnackbar(message = message, duration = SnackbarDuration.Short)
      snackbarMessage = null
    }
  }

  Dialog(
      onDismissRequest = onDismiss,
      properties = DialogProperties(usePlatformDefaultWidth = false)) {
        Box {
          Card(
              modifier = Modifier.fillMaxWidth().padding(Dimensions.Spacing.extraMedium),
              shape = RoundedCornerShape(Dimensions.CornerRadius.extraLarge),
              colors = CardDefaults.cardColors(containerColor = AppColors.secondary)) {
                Column(modifier = Modifier.fillMaxWidth().padding(Dimensions.Spacing.xxLarge)) {
                  Row(
                      modifier = Modifier.fillMaxWidth(),
                      horizontalArrangement = Arrangement.SpaceBetween,
                      verticalAlignment = Alignment.Top) {
                        Column(modifier = Modifier.weight(1f)) {
                          Text(
                              text = target.name,
                              color = AppColors.textIcons,
                              fontSize = Dimensions.TextSize.large,
                              fontWeight = FontWeight.Bold,
                              modifier =
                                  Modifier.testTag(
                                      CommonComponentsTestTags.USER_PROFILE_POPUP_USERNAME))

                          Text(
                              text = "@" + target.handle,
                              color = AppColors.textIcons,
                              fontSize = Dimensions.TextSize.heading,
                              modifier =
                                  Modifier.padding(top = Dimensions.Spacing.medium)
                                      .testTag(CommonComponentsTestTags.USER_PROFILE_POPUP_HANDLE))
                        }

                        // Profile image
                        if (target.photoUrl.isNullOrBlank()) {
                          Box(
                              modifier =
                                  Modifier.size(Dimensions.IconSize.massive)
                                      .clip(CircleShape)
                                      .background(AppColors.textIconsFade)
                                      .testTag(CommonComponentsTestTags.USER_PROFILE_POPUP_AVATAR),
                              contentAlignment = Alignment.Center) {
                                Icon(
                                    imageVector = Icons.Default.Person,
                                    contentDescription = "No avatar for display",
                                    tint = AppColors.divider,
                                    modifier = Modifier.size(Dimensions.IconSize.giant))
                              }
                        } else {
                          Image(
                              painter = rememberAsyncImagePainter(target.photoUrl),
                              contentDescription = "User's avatar",
                              contentScale = ContentScale.Crop,
                              modifier =
                                  Modifier.size(Dimensions.IconSize.massive)
                                      .clip(CircleShape)
                                      .testTag(CommonComponentsTestTags.USER_PROFILE_POPUP_AVATAR))
                        }
                      }

                  var isExpanded by remember { mutableStateOf(false) }
                  var showShowMore by remember { mutableStateOf(false) }
                  val maxLinesNotExpanded = 3
                  val maxLinesExpanded = 5
                  val description = target.description ?: "This user does not have a description."

                  // Bio
                  Text(
                      text = description,
                      color = AppColors.textIcons,
                      modifier =
                          Modifier.padding(
                                  bottom = Dimensions.Spacing.medium,
                                  top = Dimensions.Spacing.extraLarge)
                              .testTag(CommonComponentsTestTags.USER_PROFILE_POPUP_DESCRIPTION),
                      fontSize = Dimensions.TextSize.subtitle,
                      maxLines = if (isExpanded) maxLinesExpanded else maxLinesNotExpanded,
                      overflow = TextOverflow.Ellipsis,
                      onTextLayout = { textLayoutResult ->
                        showShowMore = textLayoutResult.hasVisualOverflow
                      })

                  if (showShowMore || isExpanded) {
                    Text(
                        text = if (isExpanded) "Show less" else "Show more",
                        color =
                            AppColors.textIcons.copy(
                                alpha = Dimensions.Alpha.dialogIconTranslucent),
                        fontSize = Dimensions.TextSize.standard,
                        modifier =
                            Modifier.padding(top = Dimensions.Spacing.small).clickable {
                              isExpanded = !isExpanded
                            })
                  }

                  // Action buttons
                  Row(
                      modifier = Modifier.fillMaxWidth(),
                      horizontalArrangement = Arrangement.spacedBy(Dimensions.Spacing.extraLarge)) {
                        // Block button
                        Button(
                            onClick = {
                              actions.onBlock(curr, target)
                              snackbarMessage = "Blocked ${target.name} successfully."
                            },
                            modifier =
                                Modifier.weight(0.7f)
                                    .testTag(
                                        CommonComponentsTestTags.USER_PROFILE_POPUP_BLOCK_BUTTON),
                            enabled = online,
                            colors =
                                ButtonDefaults.buttonColors(
                                    containerColor = AppColors.negative,
                                    contentColor = AppColors.textIcons),
                            shape = RoundedCornerShape(Dimensions.CornerRadius.medium),
                            contentPadding =
                                PaddingValues(vertical = Dimensions.Spacing.extraLarge)) {
                              Icon(
                                  imageVector = Icons.Default.Block,
                                  contentDescription = "Block",
                                  tint = AppColors.textIcons,
                                  modifier = Modifier.size(Dimensions.IconSize.standard))
                              Spacer(modifier = Modifier.width(Dimensions.Spacing.medium))
                              Text(
                                  text = "Block",
                                  color = AppColors.textIcons,
                                  fontSize = Dimensions.TextSize.subtitle)
                            }

                        // Send friend request button
                        if (!isFriend) {
                          val isRequestSent =
                              curr.relationships[target.uid] == RelationshipStatus.SENT
                          Button(
                              onClick = {
                                if (!isRequestSent) {
                                  actions.onSendFriendRequest(curr, target)
                                  snackbarMessage = "Friend request sent to ${target.name}."
                                } else {
                                  actions.onCancel(curr, target)
                                  snackbarMessage =
                                      "Successfully canceled friend request to ${target.name}."
                                }
                              },
                              modifier =
                                  Modifier.weight(1f)
                                      .testTag(
                                          CommonComponentsTestTags
                                              .USER_PROFILE_POPUP_SEND_REQUEST_BUTTON),
                              enabled = online,
                              colors =
                                  ButtonDefaults.buttonColors(
                                      containerColor =
                                          if (isRequestSent) AppColors.neutral
                                          else AppColors.affirmative,
                                      contentColor = AppColors.textIcons,
                                      disabledContainerColor =
                                          if (isRequestSent) AppColors.neutral
                                          else ButtonDefaults.buttonColors().disabledContainerColor,
                                      disabledContentColor = AppColors.textIcons),
                              shape = RoundedCornerShape(Dimensions.CornerRadius.medium),
                              contentPadding =
                                  PaddingValues(vertical = Dimensions.Spacing.extraLarge)) {
                                Icon(
                                    imageVector =
                                        if (isRequestSent) Icons.Default.Person
                                        else Icons.Default.PersonAdd,
                                    contentDescription =
                                        if (isRequestSent) "Cancel request"
                                        else "Send friend request",
                                    tint = AppColors.textIcons,
                                    modifier = Modifier.size(Dimensions.IconSize.standard))
                                Spacer(modifier = Modifier.width(Dimensions.Spacing.medium))
                                Text(
                                    text =
                                        if (isRequestSent) "Cancel request"
                                        else "Send friend request",
                                    color = AppColors.textIcons,
                                    fontSize = Dimensions.TextSize.subtitle)
                              }
                        } else {
                          Button(
                              onClick = {
                                actions.onRemoveFriend(curr, target)
                                snackbarMessage = "${target.name} removed from friends."
                              },
                              modifier =
                                  Modifier.weight(1f)
                                      .testTag(
                                          CommonComponentsTestTags
                                              .USER_PROFILE_POPUP_REMOVE_FRIEND_BUTTON),
                              enabled = online,
                              colors =
                                  ButtonDefaults.buttonColors(
                                      containerColor = AppColors.primary,
                                      contentColor = AppColors.textIcons),
                              shape = RoundedCornerShape(Dimensions.CornerRadius.medium),
                              contentPadding =
                                  PaddingValues(vertical = Dimensions.Spacing.extraLarge)) {
                                Icon(
                                    imageVector = Icons.Default.PersonRemove,
                                    contentDescription = "Remove friend",
                                    tint = AppColors.textIcons,
                                    modifier = Modifier.size(Dimensions.IconSize.standard))
                                Spacer(modifier = Modifier.width(Dimensions.Spacing.medium))
                                Text(
                                    text = "Remove friend",
                                    color = AppColors.textIcons,
                                    fontSize = Dimensions.TextSize.subtitle)
                              }
                        }
                      }
                }
              }

          // Snackbar
          SnackbarHost(
              hostState = snackbarHostState,
              modifier =
                  Modifier.align(Alignment.BottomCenter)
                      .padding(Dimensions.Spacing.extraLarge)
                      .offset(y = SNACKBAR_OFFSET),
              snackbar = { data ->
                Snackbar(
                    snackbarData = data,
                    containerColor = AppColors.primary,
                    contentColor = AppColors.textIcons)
              })
        }
      }
}
