/** Sections of this file were generated by ChatGPT */
package com.github.meeplemeet.ui.components

import android.Manifest
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.compose.ui.test.*
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.test.ext.junit.runners.AndroidJUnit4
import androidx.test.rule.GrantPermissionRule
import com.github.meeplemeet.ui.discussions.UITestTags
import com.github.meeplemeet.utils.Checkpoint
import com.github.meeplemeet.utils.FirestoreTests
import kotlinx.coroutines.runBlocking
import org.junit.*
import org.junit.runner.RunWith

@RunWith(AndroidJUnit4::class)
class CommonComponentsTest : FirestoreTests() {

  @get:Rule
  val permissionRule: GrantPermissionRule = GrantPermissionRule.grant(Manifest.permission.CAMERA)

  @get:Rule val compose = createComposeRule()

  /* ---------------- checkpoint helper ---------------- */
  @get:Rule val ck = Checkpoint.Rule()

  private fun checkpoint(name: String, block: () -> Unit) = ck.ck(name, block)

  /* ---------------- semantic helpers ---------------- */

  private fun addButton() = compose.onNodeWithTag(CommonComponentsTestTags.CAROUSEL_ADD_BUTTON)

  private fun galleryDialogImage() =
      compose.onNodeWithTag(CommonComponentsTestTags.GALLERY_DIALOG_ROOT)

  private fun carouselImageNodes() =
      compose.onAllNodesWithTag(CommonComponentsTestTags.CAROUSEL_IMAGE)

  private fun confirmationDialog() =
      compose.onNodeWithTag(CommonComponentsTestTags.CONFIRMATION_DIALOG)

  private fun confirmationDialogTitle() =
      compose.onNodeWithTag(CommonComponentsTestTags.CONFIRMATION_DIALOG_TITLE)

  private fun confirmationDialogMessage() =
      compose.onNodeWithTag(CommonComponentsTestTags.CONFIRMATION_DIALOG_MESSAGE)

  private fun confirmationDialogConfirm() =
      compose.onNodeWithTag(CommonComponentsTestTags.CONFIRMATION_DIALOG_CONFIRM)

  private fun confirmationDialogCancel() =
      compose.onNodeWithTag(CommonComponentsTestTags.CONFIRMATION_DIALOG_CANCEL)

  /* ------------------------- setup ---------------------------- */

  private var showGalleryDialog by mutableStateOf(false)
  private var galleryEditable by mutableStateOf(true)
  private var carouselImages by mutableStateOf<List<String>>(emptyList())

  private var showConfirmationDialog by mutableStateOf(false)
  private var confirmationTitle by mutableStateOf("Test Title")
  private var confirmationMessage by mutableStateOf("Test Message")
  private var confirmClicked by mutableStateOf(false)
  private var dismissClicked by mutableStateOf(false)

  @Before
  fun setup() = runBlocking {
    compose.setContent {
      if (showGalleryDialog) {
        GalleryDialog(
            pageNumber = 0,
            galleryPictureUrl = carouselImages,
            onDismiss = { showGalleryDialog = false },
            onTakePhoto = {},
            onChooseFromGallery = {},
            editable = galleryEditable)
      }
      ImageCarousel(photoCollectionUrl = carouselImages, editable = true)

      ConfirmationDialog(
          show = showConfirmationDialog,
          title = confirmationTitle,
          message = confirmationMessage,
          confirmText = "Confirm",
          cancelText = "Cancel",
          onConfirm = {
            confirmClicked = true
            showConfirmationDialog = false
          },
          onDismiss = {
            dismissClicked = true
            showConfirmationDialog = false
          })
    }
    // initialize default state for tests
    showGalleryDialog = false
    galleryEditable = true
    carouselImages = emptyList()
    showConfirmationDialog = false
    confirmClicked = false
    dismissClicked = false
    confirmationTitle = "Test Title"
    confirmationMessage = "Test Message"
  }

  /* ---------------------- tests ------------------------------- */

  @OptIn(ExperimentalTestApi::class)
  @Test
  fun full_smoke_common_components() = runBlocking {

    /* 1  Initial state ------------------------------------------------------------- */
    checkpoint("No images initially") {
      compose.waitForIdle()
      addButton().assertExists()
    }

    /* 2  Dots indicator hidden for 0â€“1 images ------------------------------------- */
    checkpoint("Dots hidden for 0 images") {
      compose.onAllNodes(hasTestTag(CommonComponentsTestTags.DOT)).assertCountEquals(0)
    }

    /* 3  Open GalleryDialog -------------------------------------------------------- */
    showGalleryDialog = true
    compose.waitForIdle()
    checkpoint("GalleryDialog opened") { galleryDialogImage().assertExists() }

    /* 4  Top bar works ------------------------------------------------------------- */
    compose.onNodeWithTag(CommonComponentsTestTags.PHOTO_DIALOG_BACK_BUTTON).performClick()
    compose.waitForIdle()
    checkpoint("GalleryDialog dismissed") { galleryDialogImage().assertDoesNotExist() }

    /* 5  Bottom bar actions visible when editable --------------------------------- */
    showGalleryDialog = true
    galleryEditable = true
    compose.waitForIdle()
    checkpoint("Bottom bar camera visible") {
      compose.onNodeWithTag(UITestTags.PROFILE_PICTURE_CAMERA_OPTION).assertExists()
    }
    checkpoint("Bottom bar gallery visible") {
      compose.onNodeWithTag(UITestTags.PROFILE_PICTURE_GALLERY_OPTION).assertExists()
    }

    /* 6  Non-editable mode hides PhotoDialogBottomBar ----------------------------- */
    galleryEditable = false
    compose.waitForIdle()
    checkpoint("Bottom bar hidden when not editable") {
      compose.onNodeWithTag(UITestTags.PROFILE_PICTURE_CAMERA_OPTION).assertDoesNotExist()
      compose.onNodeWithTag(UITestTags.PROFILE_PICTURE_GALLERY_OPTION).assertDoesNotExist()
    }

    /* 7  Dots indicator logic for multiple images -------------------------------- */
    showGalleryDialog = false
    carouselImages = listOf("url1", "url2", "url3")
    compose.waitForIdle()
    checkpoint("Dots visible for >1 images") {
      compose.onAllNodes(hasTestTag(CommonComponentsTestTags.DOT)).assertCountEquals(4)
    }

    // Removed: pager().performScrollToIndex(2)

    // Update state to simulate no images before clicking add button
    carouselImages = emptyList()
    showGalleryDialog = false
    compose.waitForIdle() // Refresh the UI

    // Show the image source menu (simulate clicking the add button)
    addButton().assertExists().performClick()
    compose.waitForIdle()

    checkpoint("GalleryDialog appears") { galleryDialogImage().assertExists() }
  }

  @Test
  fun confirmation_dialog_not_shown_when_show_is_false() = runBlocking {
    checkpoint("Dialog not shown initially") {
      compose.waitForIdle()
      confirmationDialog().assertDoesNotExist()
    }
  }

  @Test
  fun confirmation_dialog_displays_title_and_message() = runBlocking {
    showConfirmationDialog = true
    compose.waitForIdle()

    checkpoint("Dialog shown") { confirmationDialog().assertExists() }

    checkpoint("Title displayed") {
      confirmationDialogTitle().assertExists().assertTextEquals("Test Title")
    }

    checkpoint("Message displayed") {
      confirmationDialogMessage().assertExists().assertTextEquals("Test Message")
    }
  }

  @Test
  fun confirmation_dialog_confirm_button_works() = runBlocking {
    showConfirmationDialog = true
    compose.waitForIdle()

    checkpoint("Confirm button exists") { confirmationDialogConfirm().assertExists() }

    checkpoint("Confirm button click triggers callback") {
      confirmationDialogConfirm().performClick()
      compose.waitForIdle()
      assert(confirmClicked) { "Confirm callback was not triggered" }
      confirmationDialog().assertDoesNotExist()
    }
  }

  @Test
  fun confirmation_dialog_cancel_button_works() = runBlocking {
    showConfirmationDialog = true
    compose.waitForIdle()

    checkpoint("Cancel button exists") { confirmationDialogCancel().assertExists() }

    checkpoint("Cancel button click triggers dismiss callback") {
      confirmationDialogCancel().performClick()
      compose.waitForIdle()
      assert(dismissClicked) { "Dismiss callback was not triggered" }
      confirmationDialog().assertDoesNotExist()
    }
  }
}
